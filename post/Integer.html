<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>
        
            Integer的自动装箱与拆箱
                 
    </title>
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="jacho" />
    <meta name="description" content="Integer的自动装箱与拆箱" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/css/violet.css" type="text/css" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="http://feeds.feedburner.com/jachohx" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', UA-35504774-1]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body class="post-content">
	<header class="inner"><h1 class="left"><a href="/">DreamCoder</a></h1>
	<div class="right">
		<form class="search right" action="http://google.com/search" method="get">
			<input class="left" type="text" name="q" results="0">
			<input type="hidden" name="q" value="site:">
		</form>
		<div class="social right">
			<a class="facebook" href="http://facebook.com/jachohx" title="Facebook">Facebook</a>
			<a class="google" href="https://plus.google.com/" title="Google+">Google+</a>
			<a class="twitter" href="http://" title="Twitter">Twitter</a>
			<a class="github" href="https://" title="GitHub">GitHub</a>
			<a class="rss" href="http://http://feeds.feedburner.com/jachohx" title="RSS">RSS</a>
		</div>
	</div>

	</header>
        <section class="content fn-clear" id="i-am-top">
        <div class="content-cnt">
        <div class="ui-grid-25 ui-grid-right content-top">
            <section class="ui-grid-23 violet-post">
                <div class="v-section-tit">
                    <a href="/" rel="nofollow" >首页</a>
                    <span>&#9830;</span>
                    <h2>Integer的自动装箱与拆箱</h2>
                </div>
                <div class="violet-post-det fn-clear">
                    <div class="ui-grid-15 v-post-detail">
                        <div class="v-entry">
                            <h1 class="title">Integer的自动装箱与拆箱</h1>
                            <p class="meta"><time class="date" pubdate="2012-11-16">2012-11-16</time> By <a href="/contact.html" class="author" title="author">jacho</a>
							<label>分类</label>
							
								<a href="#/category/tech">技术</a>
							
							<label>标签</label>
							
								<a href="#/tag/java">java</a>
							</p>
                            <p class="description">Integer的自动装箱与拆箱</p>
                            <p>最近看到一行代码</p>

<pre><code>map.put(key, Integer.valueOf("1"));
</code></pre>

<p>Map是HashMap&lt;String, Integer>();</p>

<p>首先这行代码效率肯定是很低的，1是数字，然后转成了字符，再转成数字。</p>

<p>首先，既然是数字，那么就没有必要用“1”了，直接Integer.valueOf(1)就可以了。</p>

<p>最简单的写法是1。</p>

<p>但考虑到自动装箱boxing 是在JDK1.5后才有的，所以1.4还是要用new Integer(1)或Integer(1)。</p>

<p>下面来看下这段代码</p>

<pre><code>Integer i1 = 1;
Integer i2 = new Integer(1);
Integer i3 = Integer.valueOf(1);    
Integer i4 = Integer.valueOf("1");
Integer i5 = 129;       
int i6 = i5;
</code></pre>

<p>在Class文件里可以看到</p>

<pre><code>0  iconst_1
1  invokestatic java.lang.Integer.valueOf(int) : java.lang.Integer [16]
4  astore_1 [i1]
5  new java.lang.Integer [17]
8  dup
9  iconst_1
10  invokespecial java.lang.Integer(int) [22]
13  astore_2 [i2]
14  iconst_1
15  invokestatic java.lang.Integer.valueOf(int) : java.lang.Integer [16]
18  astore_3 [i3]
19  ldc &lt;String "1"&gt; [25]
21  invokestatic java.lang.Integer.valueOf(java.lang.String) : java.lang.Integer [27]
24  astore 4 [i4]
26  sipush 129
29  invokestatic java.lang.Integer.valueOf(int) : java.lang.Integer [16]
32  astore 5 [i5]
34  aload 5 [i5]
36  invokevirtual java.lang.Integer.intValue() : int [30]
39  istore 6 [i6]
</code></pre>

<p>i1是1，JDK会自动装箱boxing，调用Integer.valueOf(int)方法。与i3是一样的效果。</p>

<p>而i2是直接new 一个新的Integer。</p>

<p>i4也调用了valueOf方法，不过比valueOf(int)多了一个步骤parseInt(s, 10)。</p>

<p>i5与i1一样，不过还是有一点区别，等下再看下valueOf的方法。</p>

<p>i6是一个自动拆箱unboxing，调用Integer.intValue方法。</p>

<p>下面再来看下valueOf(int)这个方法</p>

<pre><code>public static Integer valueOf(int i) {
    final int offset = 128;
    if (i &gt;= -128 &amp;&amp; i &lt;= 127) { // must cache 
        return IntegerCache.cache[i + offset];
    }
    return new Integer(i);
}
</code></pre>

<p>在看下IntegerCache</p>

<pre><code>private static class IntegerCache {
    private IntegerCache(){}

    static final Integer cache[] = new Integer[-(-128) + 127 + 1];

    static {
        for(int i = 0; i &lt; cache.length; i++)
        cache[i] = new Integer(i - 128);
    }
}
</code></pre>

<p>IntegerCache会对-128~127之间的数做一个缓存，在valueOf方法里，对-128~127之间的数直接使用IntegerCache缓存，不在这个范围的，则new Integer(int)方法。</p>

<pre><code>System.out.println(Integer.valueOf(127) == Integer.valueOf(127));
System.out.println(Integer.valueOf(129) == Integer.valueOf(129));
</code></pre>

<p>这两个的输出是true，false，也就是第一个用了缓存，第二个都是new出来的对象。</p>

<p>所以最开始那个代码可以使用</p>

<pre><code>map.put(key, 1);
</code></pre>

<p>当然为了兼容1.4那么就写成</p>

<pre><code>map.put(key, Integer.valueOf(1));
</code></pre>

<p>但最好不要用</p>

<pre><code>map.put(key, new Integer(1));
</code></pre>

                        </div>
                        <nav class="v-pagination">
                            
                            <a class="prev" href="/post/github-pages.html" rel="bookmark">&laquo;&nbsp;使用Github Pages建独立博客</a>
                            
                            
                            <a class="next" href="/post/jekyll-rsync.html" rel="bookmark">用vps写jekyll&nbsp;&raquo;</a>
                            
                         </nav>
                         <div class="violet-comment">
                             <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'jachohx'; // required: replace example with your forum shortname
	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
                         </div><!-- //violet-comment -->
                    </div>                   
                </div>
            </section><!-- //violet-post -->
        </div>
        </div>
    </section><!-- //content -->

    <a class="v-fork-me" href="https://github.com/jachohx" target="_blank" rel="nofollow">
        <img src="/images/forkme.png" alt="Fork me on GitHub">
    </a>
</body>
</html>
